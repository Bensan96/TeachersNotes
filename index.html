<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Note Dictation Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load html2pdf for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .container-wrapper {
            max-width: 640px; /* sm breakpoint */
            min-height: 100vh;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div id="app" class="container-wrapper mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-8 space-y-6">

        <header class="text-center pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900">Lesson Log Assistant</h1>
            <p class="text-sm text-gray-500 mt-1">Dictate your lesson notes quickly and easily.</p>
        </header>

        <!-- Message Box for User Feedback -->
        <div id="messageBox" class="hidden p-3 text-sm rounded-lg font-medium shadow-md transition duration-300" role="alert">
            <p id="messageText"></p>
        </div>

        <div id="lessonForm" class="space-y-6">

            <!-- Lesson Topic -->
            <div class="space-y-2">
                <label for="lessonTopic" class="text-sm font-semibold text-gray-700 block">1. Lesson Topic</label>
                <div class="flex items-start space-x-2">
                    <textarea id="lessonTopic" class="flex-grow w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base" rows="1" placeholder="Type or speak the lesson topic..."></textarea>
                    <button type="button" data-target="lessonTopic" class="speak-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition duration-150 whitespace-nowrap text-sm h-10 flex-shrink-0">
                        Start Speaking
                    </button>
                </div>
            </div>

            <!-- Learning Objectives -->
            <div class="space-y-2">
                <label for="learningObjectives" class="text-sm font-semibold text-gray-700 block">2. Learning Objectives Achieved</label>
                <div class="flex items-start space-x-2">
                    <textarea id="learningObjectives" class="flex-grow w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base" rows="3" placeholder="Type or speak the key objectives covered..."></textarea>
                    <button type="button" data-target="learningObjectives" class="speak-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition duration-150 whitespace-nowrap text-sm h-10 flex-shrink-0">
                        Start Speaking
                    </button>
                </div>
            </div>

            <!-- Main Activities -->
            <div class="space-y-2">
                <label for="mainActivities" class="text-sm font-semibold text-gray-700 block">3. Main Activities & Student Engagement</label>
                <div class="flex items-start space-x-2">
                    <textarea id="mainActivities" class="flex-grow w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base" rows="5" placeholder="Type or speak a summary of the main tasks and student interaction..."></textarea>
                    <button type="button" data-target="mainActivities" class="speak-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition duration-150 whitespace-nowrap text-sm h-10 flex-shrink-0">
                        Start Speaking
                    </button>
                </div>
            </div>

            <!-- Teacher Reflection -->
            <div class="space-y-2">
                <label for="teacherReflection" class="text-sm font-semibold text-gray-700 block">4. Teacher Reflection & Next Steps</label>
                <div class="flex items-start space-x-2">
                    <textarea id="teacherReflection" class="flex-grow w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-base" rows="4" placeholder="Type or speak your personal reflection and plan for the next lesson..."></textarea>
                    <button type="button" data-target="teacherReflection" class="speak-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition duration-150 whitespace-nowrap text-sm h-10 flex-shrink-0">
                        Start Speaking
                    </button>
                </div>
            </div>
            
            <!-- New PDF Download Button -->
            <button type="button" onclick="downloadPDF()" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                Download Notes as PDF
            </button>

            <button type="button" onclick="document.getElementById('lessonForm').reset()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition duration-150 shadow-inner">
                Clear All Notes
            </button>

        </div>
    </div>

    <script>
        // Check for SpeechRecognition support across different browsers
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const speakButtons = document.querySelectorAll('.speak-btn');
        const originalButtonText = "Start Speaking";
        
        let recognition = null;
        let isRecognizing = false;
        let currentTargetButton = null;
        let currentTargetElement = null;

        // --- Utility Functions ---

        /**
         * Displays a message in the notification box.
         * @param {string} text The message to display.
         * @param {string} type 'success', 'error', or 'info' for styling.
         */
        function displayMessage(text, type = 'info') {
            messageText.textContent = text;
            messageBox.className = "p-3 text-sm rounded-lg font-medium shadow-md transition duration-300";
            messageBox.classList.remove('hidden');

            // Apply Tailwind classes based on type
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }

            // Automatically hide after 4 seconds
            clearTimeout(window.messageTimer);
            window.messageTimer = setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 4000);
        }

        /**
         * Updates the state of the button (text and color)
         * @param {Element} button The button element to update.
         * @param {boolean} active If true, set to active state (listening).
         */
        function updateButtonState(button, active) {
            if (active) {
                // Disable all buttons initially
                speakButtons.forEach(btn => btn.disabled = true);
                
                // Set active button state
                button.textContent = "Stop Dictation";
                button.disabled = false; // Re-enable the active button to allow stopping
                button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                button.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                // Reset button state
                button.textContent = originalButtonText;
                button.classList.remove('bg-red-500', 'hover:bg-red-600');
                button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                
                // Re-enable all buttons once recognition is finished/stopped
                speakButtons.forEach(btn => btn.disabled = false);
            }
        }

        // --- Speech Recognition Core Functions ---

        function startRecognition(targetElement, button) {
            if (!SpeechRecognition) {
                displayMessage("Speech recognition is not supported in this browser.", 'error');
                return;
            }

            // Clean up any lingering recognition state
            if (isRecognizing) {
                // Stop current instance immediately before starting a new one
                stopRecognition(false); 
            }

            // Initialize/reset recognition instance
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US'; 

            currentTargetElement = targetElement;
            currentTargetButton = button;
            
            // Store original content to append to
            currentTargetElement.dataset.originalContent = currentTargetElement.value;

            recognition.onstart = () => {
                isRecognizing = true;
                updateButtonState(currentTargetButton, true);
                displayMessage(`Dictation started for ${targetElement.id}. Speak now...`, 'info');
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update value with previous content + new final + interim
                currentTargetElement.value = currentTargetElement.dataset.originalContent + finalTranscript + interimTranscript;
            };

            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error);
                let errorMessage = 'An error occurred during speech recognition. Check microphone permissions.';
                stopRecognition(false); // Stop cleanup, but prevent success message
                displayMessage(errorMessage, 'error');
            };

            recognition.onend = () => {
                // Final commit of text and cleanup
                if (currentTargetElement && currentTargetElement.dataset.originalContent) {
                    // Commit the final text (stripping potential trailing interim text)
                    currentTargetElement.value = currentTargetElement.value.trim();
                    delete currentTargetElement.dataset.originalContent;
                }
                
                // Only clean up UI if not handled by onerror
                if (currentTargetButton && !messageBox.classList.contains('bg-red-100')) {
                    updateButtonState(currentTargetButton, false);
                }
                
                isRecognizing = false;
                currentTargetButton = null;
                currentTargetElement = null;
                
                // Show success message only if not already showing an error
                if (!messageBox.classList.contains('bg-red-100')) {
                    displayMessage('Dictation session ended.', 'success');
                }
            };
            
            recognition.start();
        }

        function stopRecognition(showSuccessMessage = true) {
            if (recognition && isRecognizing) {
                recognition.stop();
                if (showSuccessMessage) {
                    // onend handler will run and perform cleanup
                    // We rely on onend to show the success message
                }
            } else {
                // Handle manual cleanup if state is inconsistent
                if (currentTargetButton) {
                    updateButtonState(currentTargetButton, false);
                }
                isRecognizing = false;
                currentTargetButton = null;
                currentTargetElement = null;
            }
        }


        // --- Event Listener Setup ---

        speakButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);

                // Logic to stop the current dictation
                if (isRecognizing && currentTargetButton && currentTargetButton.isEqualNode(button)) {
                    stopRecognition();
                } 
                // Logic to switch dictation to a new field, or start a new one
                else {
                    // Stop current recognition (if any) before starting the new one
                    if (isRecognizing) {
                        stopRecognition(false); // Do not show success message when switching
                        // Add a small delay when switching to prevent race condition/InvalidStateError
                        setTimeout(() => startRecognition(targetElement, button), 50);
                    } else {
                        startRecognition(targetElement, button);
                    }
                }
            });
        });
        
        // --- PDF Download Function ---

        /**
         * Downloads the content of the lesson notes section as a PDF.
         */
        function downloadPDF() {
            // Select the main content div for PDF conversion
            const element = document.getElementById('lessonForm');
            
            // Create a temporary element to hold the header for the PDF
            const date = new Date().toISOString().slice(0, 10);
            const header = document.createElement('div');
            header.innerHTML = `<h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px;">Lesson Log - ${date}</h1>`;

            // Prepare the element for PDF conversion: temporarily append the header
            element.insertBefore(header, element.firstChild); 
            
            // Configuration for html2pdf
            const options = {
                margin: 10,
                filename: 'Lesson_Log_' + date + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            displayMessage("Generating PDF...", 'info');
            
            html2pdf().from(element).set(options).save().then(() => {
                // Remove the temporary header after saving
                element.removeChild(header);
                displayMessage("PDF downloaded successfully!", 'success');
            }).catch(error => {
                console.error("PDF generation failed:", error);
                // Remove the temporary header even on failure
                if(header.parentNode) {
                    header.parentNode.removeChild(header);
                }
                displayMessage("Failed to generate PDF. Check console for details.", 'error');
            });
        }


        // Initialize on window load (optional, but good practice)
        window.onload = function() {
            if (!SpeechRecognition) {
                displayMessage("Speech recognition is not available on this device/browser.", 'error');
            } else {
                displayMessage("App is ready! Tap 'Start Speaking' to begin dictating.", 'info');
            }
        };

    </script>
</body>
</html>
